#!/usr/bin/env php
<?php
include(dirname(__DIR__) . '/_prepend.php');

use Symfony\Component\Console\Application;
use Symfony\Component\Console\Input\ArgvInput;
use Symfony\Component\Console\Output\ConsoleOutput;


// Ensure only one instance running
//exec("ps aux | grep " . basename(__FILE__), $output, $return);
//if (count($output) > 3) exit();
set_time_limit(0);

$input = new ArgvInput();
$output = new ConsoleOutput();

//Determine Environment
$env = $input->getParameterOption(array('--env', '-e'), getenv('MYAPP_ENV') ?: 'prod');
$app['environment'] = $env;

try {

    $config = \App\Config::getInstance();

    if ($config->getSiteHost())
      $_SERVER['HTTP_HOST'] = $config->getSiteHost();

    $app = new Application($config->get('site.title') , $config->get('system.info.version'));

    $log = null;
    if ($config->get('event.dispatcher.log')) {
        $log = $config->getLog();
    }
    $dispatcher = new \Tk\Sym\EventDispatcher($log);
    $config->set('event.dispatcher', $dispatcher);

    // Init the plugins
    $config->getPluginFactory();
    // Initiate the email gateway
    $config->getEmailGateway();


    $app->setDispatcher($dispatcher);
    $app->add(new \App\Console\Cron());
    $app->add(new \Bs\Console\Upgrade());

    if ($config->isDebug()) {
        $app->add(new \Bs\Console\Debug());
        $app->add(new \Bs\Console\Mirror());
        $app->add(new \App\Console\Test());
    }


    $app->run($input, $output);
} catch (Exception $e) {
    echo $e->__toString();
}

